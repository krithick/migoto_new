graph TB
    subgraph "OLD SYSTEM (Pre-Archetype)"
        A1[Upload Template/Text] --> B1[Extract Scenario Info]
        B1 --> C1[Template Data Structure]
        C1 --> D1[User Edits Template]
        D1 --> E1[Generate Prompts]
        E1 --> F1[Create Personas]
        F1 --> G1[Save Scenario]
        G1 --> H1[Bot Conversation]
        
        C1 -.->|Contains| C1A[context_overview<br/>knowledge_base<br/>conversation_topics<br/>learning_objectives<br/>evaluation_metrics]
        F1 -.->|Generic Fields| F1A[name<br/>role<br/>background<br/>personality<br/>communication_style]
    end
    
    subgraph "NEW SYSTEM (With Archetype)"
        A2[Upload Template/Text] --> B2[Extract Scenario Info]
        B2 --> B2A[Classify Archetype]
        B2A --> C2[Template Data + Archetype]
        C2 --> D2[User Edits Template]
        D2 --> E2[Generate Prompts]
        E2 --> F2[Create Archetype-Aware Personas]
        F2 --> G2[Save Scenario + Archetype]
        G2 --> H2[Bot with Archetype Behaviors]
        
        C2 -.->|Contains ALL Old Fields PLUS| C2A[archetype_classification:<br/>- archetype<br/>- sub_type<br/>- confidence_score<br/>- reasoning]
        F2 -.->|Generic + Archetype Fields| F2A[OLD: name, role, background...<br/>NEW PERSUASION: objection_library<br/>NEW CONFRONTATION: defensive_mechanisms<br/>NEW: decision_criteria, emotional_state]
        H2 -.->|Enhanced Prompt| H2A[System Prompt +<br/>Archetype Instructions +<br/>Objection Library +<br/>Defensive Mechanisms]
    end
    
    subgraph "WHAT CHANGED - Code Level"
        CH1[main.py] -.->|ADDED| CH1A[seed_archetype_definitions on startup]
        CH2[scenario_generator.py] -.->|ADDED| CH2A[ArchetypeClassifier integration<br/>classify_scenario in extract_scenario_info<br/>archetype_classification param in generate_personas]
        CH3[dynamic_chat.py] -.->|ADDED| CH3A[_build_archetype_instructions method<br/>Inject archetype behaviors into system prompt]
        CH4[avatarInteraction_models.py] -.->|ADDED| CH4A[archetype field<br/>archetype_sub_type field<br/>archetype_confidence field]
        CH5[NEW FILES] -.->|CREATED| CH5A[archetype_models.py<br/>archetype_definitions.py<br/>archetype_classifier.py]
    end
    
    subgraph "BACKWARD COMPATIBILITY GUARANTEE"
        BC1[conversation_topics] --> BC2[Works for ALL Archetypes]
        BC3[Archetype-Specific Fields] --> BC4[OPTIONAL - Only Added When Needed]
        BC5[Template Editing] --> BC6[Unchanged - All Fields Editable]
        BC7[Existing Scenarios] --> BC8[Work Without Archetype Data]
        
        BC2 -.->|Maps To| BC2A[areas_to_explore in prompts]
        BC4 -.->|Examples| BC4A[objection_library only for PERSUASION<br/>defensive_mechanisms only for CONFRONTATION]
    end
    
    subgraph "DATA FLOW COMPARISON"
        DF1[OLD: Template → Generic Personas → Bot] 
        DF2[NEW: Template → Classify → Archetype Personas → Archetype Bot]
        DF3[COMPATIBILITY: Old Templates → Auto-Classify → Enhanced Personas → Enhanced Bot]
    end
    
    style A2 fill:#90EE90
    style B2A fill:#FFD700
    style F2 fill:#FFD700
    style H2 fill:#FFD700
    style CH1A fill:#87CEEB
    style CH2A fill:#87CEEB
    style CH3A fill:#87CEEB
    style CH4A fill:#87CEEB
    style CH5A fill:#87CEEB
    style BC2 fill:#98FB98
    style BC4 fill:#98FB98
    style BC6 fill:#98FB98
    style BC8 fill:#98FB98
