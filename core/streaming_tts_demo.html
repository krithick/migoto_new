<!DOCTYPE html>
<html>
<head>
    <title>True Streaming TTS Demo</title>
</head>
<body>
    <h1>True Streaming TTS with LLM</h1>
    <input type="text" id="message" placeholder="Enter message" value="مرحبا كيف حالك اليوم؟ أريد أن أتحدث معك عن الخدمات المتاحة">
    <button onclick="startStreaming()">Start Streaming Chat</button>
    <div id="status"></div>
    <div id="text-output"></div>
    <div id="audio-controls"></div>
    
    <script>
        let audioQueue = [];
        let isPlaying = false;
        
        async function startStreaming() {
            const message = document.getElementById('message').value;
            const status = document.getElementById('status');
            const textOutput = document.getElementById('text-output');
            const audioControls = document.getElementById('audio-controls');
            
            status.innerHTML = 'Streaming...';
            textOutput.innerHTML = '';
            audioControls.innerHTML = '';
            audioQueue = [];
            
            // Simulate streaming LLM response with audio chunks
            const response = await fetch('/speech/stream-with-audio', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: message})
            });
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            while (true) {
                const {done, value} = await reader.read();
                if (done) break;
                
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            
                            if (data.text) {
                                textOutput.innerHTML = data.text;
                            }
                            
                            if (data.audio_chunk) {
                                // Queue audio chunk for playback
                                audioQueue.push(data.audio_chunk);
                                playNextAudio();
                            }
                            
                            if (data.complete) {
                                status.innerHTML = 'Complete!';
                            }
                        } catch (e) {
                            console.error('Parse error:', e);
                        }
                    }
                }
            }
        }
        
        function playNextAudio() {
            if (isPlaying || audioQueue.length === 0) return;
            
            isPlaying = true;
            const audioData = audioQueue.shift();
            const audio = new Audio(`data:audio/wav;base64,${audioData}`);
            
            audio.onended = () => {
                isPlaying = false;
                playNextAudio(); // Play next chunk
            };
            
            audio.play();
        }
    </script>
</body>
</html>